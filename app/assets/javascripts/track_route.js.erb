$( document ).ready(function() {

  function initMap() {
    // setting as global scope which might be bad
    var uluru = {lat: -25.363, lng: 131.044};
    map = new google.maps.Map(document.getElementById('map-track-route'), {
      zoom: 7,
      center: uluru
    });

    $("#track-route").on("click", function(){
      var array = []
      var trackRoute = setInterval(function() {
        getLocation(function(pos){
          array.push(pos.lat.toString() + "," + pos.lng.toString())
        })
      }, 1 * 1000); // 60 * 1000 milsec
      $("#stop-track-route").on("click", function(){
        clearInterval(trackRoute);
        getRoadsPoints(array)
      })
    })

  }

  function getRoadsPoints(array) {
    $.get('https://roads.googleapis.com/v1/snapToRoads', {
      interpolate: true,
      key: "<%= ENV['GOOGLE_MAPS_API'] %>",
      path: array.join('|')
    }, function(data) {
      drawPolyLine(data);
    });
  }

  function drawPolyLine(array) {
    var snappedCoordinates = [];
    for (var i = 0; i < array.snappedPoints.length; i++) {
      var latlng = new google.maps.LatLng(
          array.snappedPoints[i].location.latitude,
          array.snappedPoints[i].location.longitude);
      snappedCoordinates.push(latlng);
    }
    var path = new google.maps.Polyline({
      path: snappedCoordinates,
      geodesic: true,
      strokeColor: '#FF0000',
      strokeOpacity: 1.0,
      strokeWeight: 2
    });

    path.setMap(map)
    savePolyLineString(google.maps.geometry.encoding.encodePath(snappedCoordinates))
    var array_mid_value = array.snappedPoints[parseInt(array.snappedPoints.length/2)].location
    newLocation(array_mid_value.latitude, array_mid_value.longitude)
  }

  function savePolyLineString(string) {
    console.log(string);
  }

  function newLocation(newLat,newLng) {
    map.setCenter({
      lat : newLat,
      lng : newLng
    });
    map.setZoom(11)
  }

  function getLocation(callback) {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        var pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        callback(pos);
      }, function() {
        handleLocationError(true, infoWindow, map.getCenter());
      });
    } else {
      // Browser doesn't support Geolocation
      handleLocationError(false, infoWindow, map.getCenter());
    }
  }

  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    alert("Some stuff went wrong")
  }

  // initMap()
})
